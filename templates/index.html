<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conners Group AI Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Theme Variables - Light Mode */
        :root[data-theme="light"] {
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --accent-color: #D4AF37;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --hover-bg: #f0f0f0;
            --message-user-bg: #e3f2fd;
            --message-assistant-bg: #f5f5f5;
            --sidebar-width: 280px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Theme Variables - Dark Mode (Default) */
        :root,
        :root[data-theme="dark"] {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --accent-color: #D4AF37;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --hover-bg: #2d3748;
            --message-user-bg: #1e40af;
            --message-assistant-bg: #374151;
            --sidebar-width: 280px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Smooth transitions for all themed elements */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* But not for transform and other non-color properties */
        button, a, input, select, textarea {
            transition: all 0.2s ease;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--secondary-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h1 {
            font-size: 18px;
            color: var(--accent-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-color) 0%, #B8960D 100%);
            color: var(--primary-bg);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .filters {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-group {
            margin-bottom: 10px;
        }

        .filter-group label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select {
            width: 100%;
            padding: 8px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 12px;
            margin-bottom: 8px;
            background: var(--primary-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }

        .conversation-item:hover {
            background: var(--hover-bg);
            border-color: var(--accent-color);
        }

        .conversation-item.active {
            background: var(--hover-bg);
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
        }

        .conversation-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .conversation-meta {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            background: var(--accent-color);
            color: var(--primary-bg);
        }

        .delete-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            opacity: 0;
            transition: all 0.2s;
        }

        .conversation-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: #b91c1c;
        }

        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--primary-bg);
        }

        .chat-header {
            padding: 20px;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .icon-btn:hover {
            background: var(--hover-bg);
            border-color: var(--accent-color);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--accent-color) 0%, #B8960D 100%);
            color: var(--primary-bg);
        }

        .message-content {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
        }

        .message.user .message-content {
            background: var(--message-user-bg);
        }

        .message.assistant .message-content {
            background: var(--message-assistant-bg);
        }

        .message-text {
            line-height: 1.6;
            word-wrap: break-word;
        }

        .message-text p {
            margin-bottom: 10px;
        }

        .message-text p:last-child {
            margin-bottom: 0;
        }

        .message-text code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .message-text pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-text pre code {
            background: none;
            padding: 0;
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            opacity: 1; /* Always visible */
        }

        .message-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .message-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .regenerate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .regenerate-btn:hover {
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }

        /* Input Area */
        .input-container {
            padding: 20px;
            background: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        textarea {
            width: 100%;
            min-height: 60px;
            max-height: 200px;
            padding: 12px 16px;
            background: var(--primary-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .input-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .char-counter {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .char-counter.warning {
            color: #fbbf24;
        }

        .char-counter.danger {
            color: #dc2626;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .attach-btn {
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .attach-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .send-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-color) 0%, #B8960D 100%);
            color: var(--primary-bg);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            align-self: flex-end;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--accent-color);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input[type="text"],
        .form-group input[type="color"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color) 0%, #B8960D 100%);
            color: var(--primary-bg);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: var(--primary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        /* Settings Modal Specific */
        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .model-option {
            padding: 12px;
            margin-bottom: 10px;
            background: var(--primary-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-option:hover {
            border-color: var(--accent-color);
        }

        .model-option.selected {
            border-color: var(--accent-color);
            background: var(--hover-bg);
        }

        .model-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .model-name {
            font-weight: 600;
            font-size: 14px;
        }

        .model-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            background: var(--accent-color);
            color: var(--primary-bg);
        }

        .model-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .model-cost {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .slider-group {
            margin-top: 15px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--primary-bg);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }

        /* Tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--accent-color);
            border-radius: 16px;
            font-size: 12px;
            color: var(--accent-color);
        }

        .tag-remove {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            line-height: 1;
        }

        .tag-input-wrapper {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .tag-input-wrapper input {
            flex: 1;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Menu Toggle */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: block;
            }

            .message {
                max-width: 95%;
            }

            .chat-header {
                padding: 15px;
                padding-left: 60px;
            }

            .messages-container {
                padding: 15px 10px;
            }

            .input-container {
                padding: 15px;
            }
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--secondary-bg);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.error {
            border-left-color: #dc2626;
        }

        .toast.success {
            border-left-color: #10b981;
        }

        /* File Upload Preview */
        .file-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .file-preview-icon {
            font-size: 24px;
            color: var(--accent-color);
        }

        .file-preview-info {
            flex: 1;
        }

        .file-preview-name {
            font-size: 13px;
            font-weight: 500;
        }

        .file-preview-size {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .file-preview-remove {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .file-preview-remove:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-brain"></i> Conners AI</h1>
                <button class="new-chat-btn" onclick="createNewConversation()">
                    <i class="fas fa-plus"></i> New Chat
                </button>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Filter by Project</label>
                    <select id="projectFilter" onchange="filterConversations()">
                        <option value="">All Projects</option>
                    </select>
                </div>
            </div>

            <div class="conversations-list" id="conversationsList">
                <!-- Conversations will be loaded here -->
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-container">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>

            <header class="chat-header">
                <div class="chat-title" id="chatTitle">Welcome to Conners AI Assistant</div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleTheme()" id="themeToggle" title="Toggle Dark/Light Mode">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <button class="icon-btn" onclick="openProjectModal()">
                        <i class="fas fa-folder-plus"></i> New Project
                    </button>
                    <button class="icon-btn" onclick="openSearchModal()">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button class="icon-btn" onclick="openSettingsModal()">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                    <button class="icon-btn" onclick="openExportModal()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="icon-btn" onclick="logout()" style="color: #dc2626;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </header>

            <div class="messages-container" id="messagesContainer">
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <div class="message-text">
                            <p>Hello! I'm your Conners Group AI Assistant. I can help you with:</p>
                            <ul>
                                <li>Legal, medical, and technical consultations</li>
                                <li>Document analysis and generation</li>
                                <li>Multi-company management support</li>
                                <li>Strategic planning and business intelligence</li>
                                <li>Multi-lingual communication</li>
                            </ul>
                            <p>How can I assist you today?</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div id="filePreviewContainer"></div>
                <div class="input-wrapper">
                    <div class="input-box">
                        <textarea 
                            id="messageInput" 
                            placeholder="Type your message here..."
                            onkeydown="handleKeyPress(event)"
                            oninput="updateCharCounter()"
                        ></textarea>
                        <div class="input-meta">
                            <div class="char-counter" id="charCounter">
                                <i class="fas fa-keyboard"></i>
                                <span>0 / 5000 characters</span>
                            </div>
                            <div class="input-actions">
                                <input type="file" id="fileInput" style="display: none;" accept=".pdf,.docx,.doc,.txt,.xlsx,.xls,.csv,.jpg,.jpeg,.png,.gif,.pptx,.ppt,.rtf,.md" onchange="handleFileSelect(event)">
                                <button class="attach-btn" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-paperclip"></i> Attach File
                                </button>
                            </div>
                        </div>
                    </div>
                    <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- New Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-folder-plus"></i> New Project</h2>
                <button class="close-btn" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" id="projectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDescription" rows="3" placeholder="Enter project description"></textarea>
                </div>
                <div class="form-group">
                    <label>Project Color</label>
                    <input type="color" id="projectColor" value="#D4AF37">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Model Selection</h3>
                    <div class="model-option selected" onclick="selectModel('claude-sonnet-4-20250514')">
                        <div class="model-option-header">
                            <span class="model-name">Claude Sonnet 4.5</span>
                            <span class="model-badge">RECOMMENDED</span>
                        </div>
                        <div class="model-description">Best balance of intelligence and speed. Perfect for everyday use.</div>
                        <div class="model-cost">$3.00 per million input tokens ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ $15.00 per million output tokens</div>
                    </div>
                    <div class="model-option" onclick="selectModel('claude-opus-4-20250514')">
                        <div class="model-option-header">
                            <span class="model-name">Claude Opus 4.1</span>
                            <span class="model-badge">MOST INTELLIGENT</span>
                        </div>
                        <div class="model-description">Highest intelligence for complex tasks requiring deep analysis.</div>
                        <div class="model-cost">$15.00 per million input tokens ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ $75.00 per million output tokens</div>
                    </div>
                    <div class="model-option" onclick="selectModel('claude-haiku-4-20250514')">
                        <div class="model-option-header">
                            <span class="model-name">Claude Haiku 4</span>
                            <span class="model-badge">FASTEST</span>
                        </div>
                        <div class="model-description">Ultra-fast responses for simple tasks and quick queries.</div>
                        <div class="model-cost">$1.00 per million input tokens ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ $5.00 per million output tokens</div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Temperature Control</h3>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span>Creativity Level</span>
                            <span id="tempValue">0.7</span>
                        </div>
                        <input type="range" id="tempSlider" min="0" max="1" step="0.1" value="0.7" oninput="updateTempValue()">
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                            <span>Precise</span>
                            <span>Balanced</span>
                            <span>Creative</span>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Max Tokens</h3>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span>Response Length</span>
                            <span id="maxTokensValue">8000</span>
                        </div>
                        <input type="range" id="maxTokensSlider" min="1000" max="16000" step="1000" value="8000" oninput="updateMaxTokensValue()">
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                            <span>Short</span>
                            <span>Medium</span>
                            <span>Long</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal" id="searchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-search"></i> Search</h2>
                <button class="close-btn" onclick="closeModal('searchModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Search Query</label>
                    <input type="text" id="searchQuery" placeholder="Enter search query">
                </div>
                <div class="form-group">
                    <label>Search Type</label>
                    <select id="searchType">
                        <option value="conversations">Search Conversations</option>
                        <option value="web">Web Search</option>
                        <option value="memory">Universal Memory</option>
                    </select>
                </div>
                <div id="searchResults" style="margin-top: 20px;"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('searchModal')">Close</button>
                <button class="btn btn-primary" onclick="performSearch()">Search</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-download"></i> Export Conversation</h2>
                <button class="close-btn" onclick="closeModal('exportModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Export Format</label>
                    <select id="exportFormat">
                        <option value="txt">Text (.txt)</option>
                        <option value="pdf">PDF (.pdf)</option>
                        <option value="md">Markdown (.md)</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('exportModal')">Cancel</button>
                <button class="btn btn-primary" onclick="exportConversation()">Export</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentConversationId = null;
        let conversations = [];
        let projects = [];
        let selectedFile = null;
        let csrfToken = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Load theme preference
            loadTheme();
            
            // Load saved settings
            loadSavedSettings();
            
            await fetchCSRFToken();
            await loadProjects();
            await loadConversations();
        });

        // ============================================
        // THEME MANAGEMENT
        // ============================================
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeIcon = document.getElementById('themeIcon');
            if (theme === 'dark') {
                themeIcon.className = 'fas fa-moon';
            } else {
                themeIcon.className = 'fas fa-sun';
            }
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            showToast(`Switched to ${newTheme} mode`, 'success');
        }

        // ============================================
        // SETTINGS PERSISTENCE
        // ============================================
        
        function loadSavedSettings() {
            const settings = JSON.parse(localStorage.getItem('aiSettings') || '{}');
            
            // Apply saved settings if they exist
            if (settings.model) {
                // Select the model option
                const modelOptions = document.querySelectorAll('.model-option');
                modelOptions.forEach(opt => {
                    if (opt.textContent.includes(settings.model)) {
                        opt.classList.add('selected');
                    } else {
                        opt.classList.remove('selected');
                    }
                });
            }
            
            if (settings.temperature) {
                const tempSlider = document.getElementById('tempSlider');
                const tempValue = document.getElementById('tempValue');
                if (tempSlider && tempValue) {
                    tempSlider.value = settings.temperature;
                    tempValue.textContent = settings.temperature;
                }
            }
            
            if (settings.maxTokens) {
                const maxTokensSlider = document.getElementById('maxTokensSlider');
                const maxTokensValue = document.getElementById('maxTokensValue');
                if (maxTokensSlider && maxTokensValue) {
                    maxTokensSlider.value = settings.maxTokens;
                    maxTokensValue.textContent = settings.maxTokens;
                }
            }
        }

        // Fetch CSRF Token
        async function fetchCSRFToken() {
            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                csrfToken = data.csrf_token;
            } catch (error) {
                console.error('Error fetching CSRF token:', error);
            }
        }

        // Load Projects
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                
                if (data.success) {
                    projects = data.projects;
                    updateProjectFilter();
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                showToast('Error loading projects', 'error');
            }
        }

        // Update Project Filter Dropdown
        function updateProjectFilter() {
            const filter = document.getElementById('projectFilter');
            filter.innerHTML = '<option value="">All Projects</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                filter.appendChild(option);
            });
        }

        // Load Conversations
        async function loadConversations() {
            try {
                const response = await fetch('/api/conversations');
                const data = await response.json();
                
                if (data.success) {
                    conversations = data.conversations;
                    renderConversations();
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                showToast('Error loading conversations', 'error');
            }
        }

        // Render Conversations List
        function renderConversations() {
            const list = document.getElementById('conversationsList');
            const filterValue = document.getElementById('projectFilter').value;
            
            // Filter conversations
            let filtered = conversations;
            if (filterValue) {
                filtered = conversations.filter(c => c.project_id == filterValue);
            }
            
            // Clear list
            list.innerHTML = '';
            
            // Render conversations
            filtered.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                if (conv.id === currentConversationId) {
                    item.classList.add('active');
                }
                
                item.innerHTML = `
                    <div class="conversation-title">
                        <span>${conv.title}</span>
                        <button class="delete-btn" onclick="deleteConversation(${conv.id}, event)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="conversation-meta">
                        <span>${new Date(conv.updated_at).toLocaleDateString()}</span>
                        ${conv.project_name ? `<span class="project-badge">${conv.project_name}</span>` : ''}
                    </div>
                `;
                
                item.onclick = (e) => {
                    if (!e.target.closest('.delete-btn')) {
                        loadConversation(conv.id);
                    }
                };
                
                list.appendChild(item);
            });
        }

        // Filter Conversations
        function filterConversations() {
            renderConversations();
        }

        // Create New Conversation
        async function createNewConversation() {
            try {
                const response = await fetch('/api/conversations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        title: `New Chat - ${new Date().toLocaleString()}`,
                        project_id: document.getElementById('projectFilter').value || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await loadConversations();
                    loadConversation(data.conversation_id);
                    showToast('New conversation created', 'success');
                } else {
                    showToast('Error creating conversation', 'error');
                }
            } catch (error) {
                console.error('Error creating conversation:', error);
                showToast('Error creating conversation', 'error');
            }
        }

        // Delete Conversation
        async function deleteConversation(conversationId, event) {
            event.stopPropagation();
            
            if (!confirm('Are you sure you want to delete this conversation? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/conversations/${conversationId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (currentConversationId === conversationId) {
                        currentConversationId = null;
                        document.getElementById('messagesContainer').innerHTML = '';
                        document.getElementById('chatTitle').textContent = 'Select a conversation';
                    }
                    await loadConversations();
                    showToast('Conversation deleted', 'success');
                } else {
                    showToast('Error deleting conversation', 'error');
                }
            } catch (error) {
                console.error('Error deleting conversation:', error);
                showToast('Error deleting conversation', 'error');
            }
        }

        // Load Conversation Messages
        async function loadConversation(conversationId) {
            try {
                currentConversationId = conversationId;
                
                const response = await fetch(`/api/conversations/${conversationId}/messages`);
                const data = await response.json();
                
                if (data.success) {
                    renderMessages(data.messages);
                    
                    // Update title
                    const conv = conversations.find(c => c.id === conversationId);
                    if (conv) {
                        document.getElementById('chatTitle').textContent = conv.title;
                    }
                    
                    // Update active state
                    renderConversations();
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
                showToast('Error loading conversation', 'error');
            }
        }

        // Render Messages
        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            messages.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.role}`;
                
                const isLastAssistant = msg.role === 'assistant' && index === messages.length - 1;
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">${msg.role === 'user' ? 'You' : 'AI'}</div>
                    <div class="message-content">
                        <div class="message-text">${formatMessageText(msg.content)}</div>
                        <div class="message-meta">
                            <span><i class="fas fa-clock"></i> ${new Date(msg.created_at).toLocaleString()}</span>
                            ${msg.tokens ? `<span><i class="fas fa-microchip"></i> ${msg.tokens} tokens</span>` : ''}
                            ${msg.cost ? `<span><i class="fas fa-dollar-sign"></i> $${msg.cost.toFixed(4)}</span>` : ''}
                        </div>
                        ${msg.role === 'assistant' ? `
                            <div class="message-actions">
                                <button class="message-action-btn" onclick="copyMessage(this)">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                ${isLastAssistant ? `
                                    <button class="message-action-btn regenerate-btn" onclick="regenerateResponse()">
                                        <i class="fas fa-redo"></i> Regenerate
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Format Message Text (Basic Markdown)
        function formatMessageText(text) {
            // Convert markdown-style formatting
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/`(.*?)`/g, '<code>$1</code>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        // Send Message
        async function sendMessage() {
            // Auto-create conversation if none exists
            if (!currentConversationId) {
                const projectId = document.getElementById('projectFilter').value || null;
                try {
                    const response = await fetch('/api/conversations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            title: `New Chat - ${new Date().toLocaleString()}`,
                            project_id: projectId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        currentConversationId = data.conversation_id;
                        await loadConversations();
                        // Continue to send message below
                    } else {
                        showToast('Error creating conversation', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('Error auto-creating conversation:', error);
                    showToast('Error creating conversation', 'error');
                    return;
                }
            }
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && !selectedFile) {
                return;
            }
            
            // Disable send button
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"></div> Sending...';
            
            try {
                const formData = new FormData();
                formData.append('conversation_id', currentConversationId);
                formData.append('message', message);
                
                if (selectedFile) {
                    formData.append('file', selectedFile);
                }
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear input
                    input.value = '';
                    selectedFile = null;
                    document.getElementById('filePreviewContainer').innerHTML = '';
                    updateCharCounter();
                    
                    // Reload messages
                    await loadConversation(currentConversationId);
                    await loadConversations(); // Update conversation list
                } else {
                    showToast(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Error sending message', 'error');
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
            }
        }

        // Regenerate Response
        async function regenerateResponse() {
            if (!currentConversationId) {
                return;
            }
            
            if (!confirm('Regenerate the last response? The current response will be deleted.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/conversations/${currentConversationId}/regenerate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await loadConversation(currentConversationId);
                    showToast('Response regenerated', 'success');
                } else {
                    showToast(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error regenerating response:', error);
                showToast('Error regenerating response', 'error');
            }
        }

        // Copy Message
        function copyMessage(button) {
            const messageContent = button.closest('.message-content').querySelector('.message-text');
            const text = messageContent.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Message copied to clipboard', 'success');
            }).catch(err => {
                showToast('Error copying message', 'error');
            });
        }

        // Handle Key Press (Enter to send, Shift+Enter for new line)
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent default newline
                sendMessage();
            }
            // Shift+Enter allows new line (default behavior)
        }

        // Update Character Counter
        function updateCharCounter() {
            const input = document.getElementById('messageInput');
            const counter = document.getElementById('charCounter');
            const length = input.value.length;
            const maxLength = 5000;
            
            // Calculate percentage
            const percentage = (length / maxLength) * 100;
            
            counter.querySelector('span').textContent = `${length} / ${maxLength} characters`;
            
            // Color coding based on percentage
            if (percentage >= 90) {
                counter.classList.add('danger');
                counter.classList.remove('warning');
            } else if (percentage >= 75) {
                counter.classList.add('warning');
                counter.classList.remove('danger');
            } else {
                counter.classList.remove('warning', 'danger');
            }
            
            // Disable send if over limit
            document.getElementById('sendBtn').disabled = length > maxLength;
        }

        // Handle File Select
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('Ã°Å¸â€Â FILE VALIDATION: Checking file:', file.name);
            
            // Ã°Å¸Å¡Â¨ CRITICAL SECURITY CHECK - Forbidden file types
            const forbiddenExtensions = [
                'exe', 'bat', 'cmd', 'com', 'msi', 'scr', 'pif',
                'vbs', 'vbe', 'js', 'jse', 'ws', 'wsf', 'wsc', 'wsh',
                'ps1', 'ps1xml', 'ps2', 'ps2xml', 'psc1', 'psc2', 'psm1',
                'dll', 'sys', 'drv', 'ocx', 'ax', 'cpl',
                'msp', 'mst', 'app', 'deb', 'rpm', 'run',
                'jar', 'apk', 'ade', 'adp',
                'reg', 'inf', 'ins', 'isp', 'job', 'lnk', 'pcd',
                'url', 'gadget', 'application', 'msc', 'hta',
                'sh', 'bash', 'zsh', 'fish', 'csh',
                'command', 'action', 'workflow',
                'xlsm', 'xlsb', 'xltm', 'xlam', 'pptm', 'potm', 'ppam',
                'ppsm', 'sldm', 'docm', 'dotm'
            ];
            
            // Get file extension (without dot)
            const fileName = file.name.toLowerCase();
            const fileExt = fileName.split('.').pop();
            
            console.log('Ã°Å¸â€Â Extension detected:', fileExt);
            
            // Check if extension is forbidden
            if (forbiddenExtensions.includes(fileExt)) {
                console.error('Ã°Å¸Å¡Â« BLOCKED:', fileExt);
                alert(`Ã°Å¸Å¡Â« SECURITY BLOCK!\n\nFile type .${fileExt} is FORBIDDEN!\n\nThis file type can execute code and pose a security risk.\n\nFile: ${file.name}`);
                showToast(`Ã°Å¸Å¡Â« DANGEROUS FILE BLOCKED: .${fileExt} files cannot be uploaded!`, 'error');
                event.target.value = ''; // Clear the input
                selectedFile = null;
                return;
            }
            
            // Check ALL extensions in filename for double-extension attacks
            const parts = fileName.split('.');
            for (let i = 0; i < parts.length; i++) {
                const ext = parts[i];
                if (forbiddenExtensions.includes(ext)) {
                    console.error('Ã°Å¸Å¡Â« BLOCKED (double extension):', ext);
                    alert(`Ã°Å¸Å¡Â« SECURITY BLOCK!\n\nSuspicious file detected!\n\nThis file has "${ext}" in its name which is forbidden.\n\nFile: ${file.name}`);
                    showToast(`Ã°Å¸Å¡Â« DANGEROUS FILE BLOCKED: Hidden .${ext} extension detected!`, 'error');
                    event.target.value = '';
                    selectedFile = null;
                    return;
                }
            }
            
            // Check file size
            const maxSize = 52428800; // 50 MB
            if (file.size > maxSize) {
                showToast(`File too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximum size is 50MB.`, 'error');
                event.target.value = '';
                return;
            }
            
            // Allowed extensions check (without dots)
            const allowedExtensions = [
                'pdf', 'docx', 'doc', 'txt', 'rtf', 'md',
                'xlsx', 'xls', 'csv',
                'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp',
                'pptx', 'ppt'
            ];
            
            if (!allowedExtensions.includes(fileExt)) {
                console.error('Ã°Å¸Å¡Â« Extension not in allowed list:', fileExt);
                showToast(`File type .${fileExt} not allowed. Allowed types: PDF, DOCX, XLSX, images, TXT`, 'error');
                event.target.value = '';
                return;
            }
            
            console.log('Ã¢Å“â€¦ FILE PASSED ALL CHECKS:', file.name);
            
            // Ã¢Å“â€¦ File passed all security checks!
            selectedFile = file;
            
            // Show preview
            const preview = document.getElementById('filePreviewContainer');
            preview.innerHTML = `
                <div class="file-preview">
                    <div class="file-preview-icon">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="file-preview-info">
                        <div class="file-preview-name">${file.name}</div>
                        <div class="file-preview-size">${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                    <button class="file-preview-remove" onclick="removeFile()">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
            `;
        }

        // Remove File
        function removeFile() {
            selectedFile = null;
            document.getElementById('filePreviewContainer').innerHTML = '';
            document.getElementById('fileInput').value = '';
        }

        // Create Project
        async function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            const color = document.getElementById('projectColor').value;
            
            if (!name) {
                showToast('Project name is required', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ name, description, color })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // CRITICAL: Reload projects immediately to show new project
                    await loadProjects();
                    closeModal('projectModal');
                    showToast('Project created successfully', 'success');
                    
                    // Clear form
                    document.getElementById('projectName').value = '';
                    document.getElementById('projectDescription').value = '';
                    document.getElementById('projectColor').value = '#D4AF37';
                    
                    // Auto-select the new project in the filter
                    const projectFilter = document.getElementById('projectFilter');
                    projectFilter.value = data.project_id;
                    await loadConversations();
                } else {
                    showToast(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error creating project:', error);
                showToast('Error creating project', 'error');
            }
        }

        // Perform Search
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const type = document.getElementById('searchType').value;
            
            if (!query) {
                showToast('Please enter a search query', 'error');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p style="margin-top: 10px; color: var(--text-secondary);">Searching...</p></div>';
            
            try {
                let endpoint, requestBody;
                
                if (type === 'conversations') {
                    endpoint = '/api/search/conversations';
                    requestBody = { query, max_results: 10 };
                } else if (type === 'web') {
                    endpoint = '/api/web-search';
                    requestBody = { query, max_results: 10 };
                } else {
                    endpoint = '/api/memory/search';
                    requestBody = { query, max_results: 10 };
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.results && data.results.length > 0) {
                    let html = `<h3 style="margin-bottom: 15px; color: var(--accent-color); font-size: 16px;">
                        <i class="fas fa-search"></i> Found ${data.results.length} results for "${query}"
                    </h3>`;
                    
                    data.results.forEach((result, index) => {
                        if (type === 'web') {
                            html += `
                                <div style="padding: 12px; background: var(--primary-bg); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="display: inline-block; width: 24px; height: 24px; background: var(--accent-color); color: var(--primary-bg); border-radius: 50%; text-align: center; line-height: 24px; font-weight: 600; font-size: 12px;">${index + 1}</span>
                                        <a href="${result.link}" target="_blank" style="color: var(--accent-color); font-weight: 600; text-decoration: none; flex: 1;">${result.title}</a>
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-left: 32px; line-height: 1.5;">${result.snippet}</p>
                                    <p style="font-size: 11px; color: var(--accent-color); margin-left: 32px; margin-top: 5px;">
                                        <i class="fas fa-link"></i> ${result.displayLink || result.link}
                                    </p>
                                </div>
                            `;
                        } else if (type === 'conversations') {
                            // Conversation search results - clickable to load conversation
                            const convId = result.conversation_id || result.id;
                            const title = result.title || result.conversation_title || 'Untitled';
                            const snippet = result.snippet || result.preview || '';
                            const projectName = result.project_name || result.project || '';
                            const updatedAt = result.updated_at || '';
                            
                            html += `
                                <div style="padding: 12px; background: var(--primary-bg); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s;" 
                                     onclick="loadConversation(${convId}); closeModal('searchModal');"
                                     onmouseover="this.style.borderColor='var(--accent-color)'; this.style.transform='translateY(-2px)';"
                                     onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)';">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="display: inline-block; width: 24px; height: 24px; background: var(--accent-color); color: var(--primary-bg); border-radius: 50%; text-align: center; line-height: 24px; font-weight: 600; font-size: 12px;">${index + 1}</span>
                                        <div style="font-weight: 600; color: var(--text-primary); flex: 1;">${title}</div>
                                    </div>
                                    ${snippet ? `<p style="font-size: 13px; color: var(--text-secondary); margin-left: 32px; line-height: 1.5; margin-bottom: 5px;">${snippet}</p>` : ''}
                                    <div style="display: flex; gap: 15px; margin-left: 32px; font-size: 11px; color: var(--text-secondary);">
                                        ${projectName ? `<span><i class="fas fa-folder"></i> ${projectName}</span>` : ''}
                                        ${updatedAt ? `<span><i class="fas fa-clock"></i> ${updatedAt}</span>` : ''}
                                    </div>
                                </div>
                            `;
                        } else {
                            // Memory search results
                            html += `
                                <div style="padding: 12px; background: var(--primary-bg); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color); cursor: pointer;" onclick="loadConversation(${result.conversation_id}); closeModal('searchModal');">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="display: inline-block; width: 24px; height: 24px; background: var(--accent-color); color: var(--primary-bg); border-radius: 50%; text-align: center; line-height: 24px; font-weight: 600; font-size: 12px;">${index + 1}</span>
                                        <div style="font-weight: 600; color: var(--text-primary); flex: 1;">${result.conversation_title}</div>
                                    </div>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin-left: 32px; line-height: 1.5;">${result.snippet}</p>
                                    ${result.project_name ? `<p style="font-size: 11px; color: var(--accent-color); margin-left: 32px; margin-top: 5px;">
                                        <i class="fas fa-folder"></i> ${result.project_name}
                                    </p>` : ''}
                                </div>
                            `;
                        }
                    });
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-search" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 15px;"></i>
                            <p style="color: var(--text-secondary); font-size: 16px;">No results found for "${query}"</p>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-top: 10px;">Try different keywords or search terms</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error performing search:', error);
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 15px;"></i>
                        <p style="color: #dc2626; font-size: 16px; font-weight: 600;">Search Error</p>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Export Conversation
        async function exportConversation() {
            if (!currentConversationId) {
                showToast('Please select a conversation to export', 'error');
                return;
            }
            
            const format = document.getElementById('exportFormat').value;
            
            try {
                window.open(`/api/export/${currentConversationId}?format=${format}`, '_blank');
                closeModal('exportModal');
                showToast('Export started', 'success');
            } catch (error) {
                console.error('Error exporting conversation:', error);
                showToast('Error exporting conversation', 'error');
            }
        }

        // Settings Functions
        function selectModel(modelId) {
            const options = document.querySelectorAll('.model-option');
            options.forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        function updateTempValue() {
            const value = document.getElementById('tempSlider').value;
            document.getElementById('tempValue').textContent = value;
        }

        function updateMaxTokensValue() {
            const value = document.getElementById('maxTokensSlider').value;
            document.getElementById('maxTokensValue').textContent = value;
        }

        function saveSettings() {
            // Get selected model
            const selectedModelOption = document.querySelector('.model-option.selected');
            const modelName = selectedModelOption ? selectedModelOption.querySelector('.model-name').textContent : 'Claude Sonnet 4.5';
            
            // Save settings to localStorage
            const settings = {
                model: modelName,
                temperature: document.getElementById('tempSlider').value,
                maxTokens: document.getElementById('maxTokensSlider').value
            };
            
            localStorage.setItem('aiSettings', JSON.stringify(settings));
            closeModal('settingsModal');
            showToast('Settings saved successfully', 'success');
        }

        // Modal Functions
        function openProjectModal() {
            document.getElementById('projectModal').classList.add('active');
        }

        function openSearchModal() {
            document.getElementById('searchModal').classList.add('active');
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function openExportModal() {
            if (!currentConversationId) {
                showToast('Please select a conversation to export', 'error');
                return;
            }
            document.getElementById('exportModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Toggle Sidebar (Mobile)
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Logout Function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }
    </script>
</body>
</html>
